<!DOCTYPE html>
<html>
<head>
    <title>Elo Ranking</title>
    <style>
        body {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            padding: 20px;
        }
        img {
            width: auto;
            height: 400px;
            border-radius: 10px;
        }
        .image-container {
            position: relative;
            display: inline-block;
            margin: 0 10px;
        }
        .overlay-btn {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            color: white;
            font-size: 1.5em;
            font-weight: bold;
            opacity: 0;
            transition: background 0.2s ease, opacity 0.2s ease;
            cursor: pointer;
            border-radius: 10px;
        }
        .overlay-btn:hover {
            background: rgba(0, 0, 0, 0.4);
            opacity: 1;
        }
        .overlay-btn:active {
            background: rgba(0, 0, 0, 0.7);
            opacity: 1;
        }
        #currentPair {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap; /* allows stacking when width is small */
        }

        /* On vertical (narrow) screens, stack vertically */
        @media (max-width: 600px) {
            #currentPair {
                flex-direction: column;
                gap: 10px;
            }
            img {
                width: auto;
                height: 200px;
                border-radius: 10px;
            }
        }
    </style>
</head>
<body>

<h1><b style="color:red;">HOT</b><b style="color:blue;">COLD</b><b>VOTE</b></h1>
<div id="arrayDisplay">Loading...</div>

<div id="currentPair" style="display:flex; gap:20px; justify-content:left; align-items:center;">
    <div id="leftImage" class="image-container">
        <!-- Left image goes here -->
    </div>
    <div id="rightImage" class="image-container">
        <!-- Right image goes here -->
    </div>
</div>

<script>
const K = 40;
const socket = new WebSocket('wss://hotcoldserver.onrender.com');
let pics = [];
let picskeys = [];
let combs = [];
let visited = [];
let currentPair = null;
let setupFinished = false;

const imageDictionary = {
    1: 'image1.jpg',
    2: 'image2.jpg',
    3: 'image3.jpg',
    4: 'image4.jpg',
    5: 'image5.jpg',
    6: 'image6.jpg',
    7: 'image7.jpg',
    8: 'image8.jpg',
    9: 'image9.jpg',
};

socket.onmessage = event => {
    const data = JSON.parse(event.data);
    if (data.type === 'array_update') {
        pics = data.data;
        setupAfterLoad(); 
    }
};

socket.onopen = function () {
    socket.send(JSON.stringify({ type: 'request_array' }));

    var t = setInterval(function () {
        if (socket.readyState !== 1) {
            clearInterval(t);
            return;
        }
        socket.send(JSON.stringify({ type: 'ping' }));
        console.log("ping");
    }, 30000);
};

function setupDefaultArray() {
    pics = [[1,1000], [2,1000], [3,1000], [4,1000], [5,1000], [6,1000], [7,1000], [8,1000], [9,1000]];
    socket.send(JSON.stringify({ type: 'update_array', data: pics }));
    setupAfterLoad();
}

function setupAfterLoad() {
    if (!pics || pics.length === 0) {
        setupDefaultArray();
        return;
    }
    picskeys = pics.map(p => p[0]);
    combs = combinations(picskeys);
    visited = [];
    displayArray();
    if (setupFinished === false) {
        let rizzCAPTCHA = prompt("本网站受 rizzCAPTCHA 保护。请输入 Sean Combs 的别名以继续。").toLowerCase();
        if (rizzCAPTCHA === "diddy") {
            nextPair();
        } else {
            while (true) {
                rizzCAPTCHA = prompt("您已被rizzCAPTCHA验证失败，现在您将被送往再教育营，以证明您对中共的忠诚。此次违规行为已导致您的社会信用分数被扣除50万分。请勿再次发生此类行为！请重新打开网站并重试。");
            }
        }
        setupFinished = true;
    }
}

function randint(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function combinations(array) {
    return array.flatMap((v, i) => array.slice(i + 1).map(w => v + ' ' + w));
}

function displayArray() {
    let sorted = [...pics].sort((a, b) => b[1] - a[1]);
    const container = document.getElementById('arrayDisplay');
    container.innerHTML = "<h3>Current Rankings:</h3><ul>";
    for (const [id, elo] of sorted) {
        const filename = imageDictionary[id] || `Unknown (ID: ${id})`;
        container.innerHTML += `<li><strong>${filename}</strong> — Elo: ${elo.toFixed(1)}</li>`;
    }
    container.innerHTML += "</ul>";
}

function nextPair() {
    if (visited.length === combs.length) visited = [];
    let rpics = combs[randint(0, combs.length - 1)];
    while (visited.includes(rpics)) {
        rpics = combs[randint(0, combs.length - 1)];
    }
    visited.push(rpics);

    let [gA, gB] = rpics.split(" ").map(Number);
    currentPair = { gA, gB };

    document.getElementById('leftImage').innerHTML = `
        <img src="${imageDictionary[gA]}" alt="Image ${gA}">
        <button class="overlay-btn" onclick="handleChoice('l')">this one</button>
    `;
    document.getElementById('rightImage').innerHTML = `
        <img src="${imageDictionary[gB]}" alt="Image ${gB}">
        <button class="overlay-btn" onclick="handleChoice('r')">this one</button>
    `;
}

function handleChoice(choice) {
    if (!currentPair) return;
    let { gA, gB } = currentPair;
    socket.send(JSON.stringify({
        type: 'choice',
        data: { gA, gB, choice }
    }));
    socket.send(JSON.stringify({ type: 'request_array' }));
    nextPair();
}
</script>

</body>
</html>